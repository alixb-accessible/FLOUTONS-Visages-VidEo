<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floutage de Visages - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
    <script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>
    <style>
        body{
            background:linear-gradient(135deg,#4a4a4a 0%,#4a4a4a 14.28%,#22c55e 14.28%,#22c55e 28.56%,#3b82f6 28.56%,#3b82f6 42.84%,#fff 42.84%,#fff 57.12%,#fbbf24 57.12%,#fbbf24 71.4%,#dc2626 71.4%,#dc2626 85.68%,#4a4a4a 85.68%,#4a4a4a 100%);
            min-height:100vh;
        }
        .app-container{min-height:100vh;}
        .app-container.dark-mode{background:#1a1a1a;}
        .face-card{border:2px solid #333;transition:all .3s;background:#2a2a2a;}
        .face-card:hover{border-color:#3b82f6;background:#333;}
        .face-card.selected{border-color:#22c55e;background:#1e3a1e;}
        .face-thumb{width:100px;height:100px;object-fit:cover;border-radius:8px;}
        .btn{transition:all .3s;font-weight:600;}
        .btn:disabled{opacity:.4;cursor:not-allowed;}
        @keyframes spin{to{transform:rotate(360deg)}}.animate-spin{animation:spin 1s linear infinite;}
        .video-container{background:#000;border-radius:12px;overflow:hidden;max-height:70vh;display:flex;align-items:center;justify-content:center;}
        .video-container video{max-width:100%;max-height:70vh;width:auto;height:auto;}
        .sidebar{background:#222;border-radius:12px;padding:1.5rem;}
    </style>
</head>
<body>
<div class="app-container min-h-screen p-6">
<div class="max-w-7xl mx-auto">

<div class="text-center mb-8">
<h1 class="text-4xl font-bold text-white mb-2">Floutage Intelligent de Visages</h1>
<p class="text-gray-400">Détection MediaPipe avec tracking précis</p>
</div>

<div class="mb-6 bg-gray-800 rounded-lg">
<button id="help-toggle" class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-700 rounded-lg transition" aria-expanded="false">
<span class="font-semibold text-white">Mode d'emploi</span>
<svg id="help-icon" class="h-5 w-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
</button>
<div id="help-content" class="hidden px-6 py-4 text-sm text-gray-300 space-y-4 border-t border-gray-700">
<div>
<h3 class="font-semibold text-blue-400 mb-2">Nouvelle version avec MediaPipe</h3>
<p class="mb-2">MediaPipe offre une détection plus précise et un meilleur tracking que BlazeFace.</p>
<ol class="list-decimal list-inside space-y-1 ml-2">
<li>Importez votre vidéo</li>
<li>Lancez l'analyse (scanne toute la vidéo)</li>
<li>Sélectionnez les visages à flouter</li>
<li>Ajoutez manuellement si besoin (bouton + Manuel)</li>
<li>Lancez le traitement avec tracking MediaPipe</li>
<li>Téléchargez votre vidéo</li>
</ol>
</div>
<div class="bg-blue-900/30 p-3 rounded border border-blue-700/50">
<p class="text-blue-300 font-medium">Confidentialité garantie</p>
<p class="text-blue-200/80 text-sm mt-1">100% local - Aucune donnée envoyée</p>
</div>
</div>
</div>

<div id="loading-model" class="hidden bg-blue-900/50 border border-blue-500/50 rounded-lg p-4 mb-6 flex items-center gap-3">
<svg class="animate-spin h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
<p class="text-blue-200">Chargement de MediaPipe Face Detection...</p>
</div>

<div id="error" class="hidden bg-red-900/50 border border-red-500/50 rounded-lg p-4 mb-6" role="alert">
<p id="error-msg" class="text-red-200"></p>
</div>

<div id="upload-section" class="bg-gray-800 rounded-lg p-8 text-center mb-6">
<input type="file" id="upload" accept="video/*" class="hidden">
<button id="upload-btn" class="btn bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-500 text-lg">Importer une vidéo</button>
<p class="text-gray-400 mt-4 text-sm">MP4, WebM, MOV</p>
</div>

<div id="main-section" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

<div class="lg:col-span-2">
<div class="video-container">
<video id="video" controls class="w-full"></video>
</div>
<div class="mt-4 flex gap-3">
<button id="analyze-btn" class="btn flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500">Analyser</button>
<button id="process-btn" disabled class="btn flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-500">Traiter</button>
</div>
</div>

<div class="sidebar">
<div class="mb-6">
<h3 class="text-white font-semibold mb-2 text-sm">Informations</h3>
<p class="text-gray-400 text-xs">Durée : <span id="video-duration" class="text-white font-mono">--:--</span></p>
<p class="text-gray-400 text-xs">Résolution : <span id="video-resolution" class="text-white font-mono">----x----</span></p>
</div>

<div class="mb-6">
<label for="blur-intensity" class="block text-white font-semibold mb-2 text-sm">Intensité du flou</label>
<input type="range" id="blur-intensity" min="10" max="50" value="25" class="w-full">
<p class="text-gray-400 text-xs mt-1 text-center"><span id="blur-val" class="text-white font-mono">25</span> pixels</p>
</div>

<div id="faces-section" class="hidden">
<div class="flex justify-between items-center mb-3">
<h3 class="text-white font-semibold text-sm">Visages (<span id="faces-count">0</span>)</h3>
<button id="add-manual" class="text-xs bg-orange-600 text-white px-3 py-1.5 rounded hover:bg-orange-500 font-semibold">+ Manuel</button>
</div>
<div class="flex gap-2 mb-3">
<button id="select-all" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 flex-1">Tout</button>
<button id="select-none" class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-500 flex-1">Aucun</button>
</div>
<div id="faces-grid" class="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto"></div>
</div>
</div>

</div>

<div id="analysis-section" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
<div class="flex items-center gap-4 mb-4">
<svg class="animate-spin h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
<div class="flex-1">
<p class="text-white font-semibold">Analyse avec MediaPipe...</p>
<p class="text-gray-400 text-sm" id="analysis-status">Préparation...</p>
</div>
</div>
<div class="w-full bg-gray-700 rounded-full h-2">
<div id="analysis-bar" class="bg-purple-500 h-full rounded-full transition-all" style="width:0%"></div>
</div>
<p class="text-gray-400 text-xs mt-2" id="analysis-percent">0%</p>
</div>

<div id="processing-section" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
<div class="flex items-center gap-4 mb-4">
<svg class="animate-spin h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
<div class="flex-1">
<p class="text-white font-semibold">Traitement MediaPipe...</p>
<p class="text-gray-400 text-sm" id="processing-status">Frame 0/0</p>
</div>
</div>
<div class="w-full bg-gray-700 rounded-full h-2">
<div id="processing-bar" class="bg-green-500 h-full rounded-full transition-all" style="width:0%"></div>
</div>
<p class="text-gray-400 text-xs mt-2"><span id="processing-percent">0%</span> - Reste : <span id="time-remaining">--:--</span></p>
</div>

<div id="result-section" class="hidden bg-gray-800 rounded-lg p-6">
<h2 class="text-white font-semibold mb-4 text-lg">Vidéo traitée</h2>
<video id="result-video" controls class="w-full rounded-lg bg-black mb-4"></video>
<div class="flex gap-3">
<button id="download-btn" class="btn flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500">Télécharger</button>
<button id="restart-btn" class="btn flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-500">Nouvelle vidéo</button>
</div>
</div>

<canvas id="temp-canvas" style="display:none"></canvas>
<canvas id="process-canvas" style="display:none"></canvas>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let faceDetection=null,videoURL=null,detectedFaces=[],selectedFaceIds=new Set();

// DOM
const helpToggle=$('help-toggle'),helpContent=$('help-content'),helpIcon=$('help-icon');
const loadingModel=$('loading-model'),error=$('error'),errorMsg=$('error-msg');
const uploadBtn=$('upload-btn'),upload=$('upload'),mainSection=$('main-section');
const video=$('video'),videoDuration=$('video-duration'),videoResolution=$('video-resolution');
const analyzeBtn=$('analyze-btn'),processBtn=$('process-btn');
const analysisSection=$('analysis-section'),analysisBar=$('analysis-bar');
const analysisPercent=$('analysis-percent'),analysisStatus=$('analysis-status');
const facesSection=$('faces-section'),facesCount=$('faces-count'),facesGrid=$('faces-grid');
const selectAll=$('select-all'),selectNone=$('select-none'),addManual=$('add-manual');
const blurIntensity=$('blur-intensity'),blurVal=$('blur-val');
const processingSection=$('processing-section'),processingBar=$('processing-bar');
const processingPercent=$('processing-percent'),processingStatus=$('processing-status');
const timeRemaining=$('time-remaining');
const resultSection=$('result-section'),resultVideo=$('result-video');
const downloadBtn=$('download-btn'),restartBtn=$('restart-btn');
const tempCanvas=$('temp-canvas'),processCanvas=$('process-canvas');
const tempCtx=tempCanvas.getContext('2d'),processCtx=processCanvas.getContext('2d');

helpToggle.onclick=()=>{
const h=helpContent.classList.toggle('hidden');
helpIcon.style.transform=h?'rotate(0)':'rotate(180deg)';
helpToggle.setAttribute('aria-expanded',!h);
};

async function loadModel(){
loadingModel.classList.remove('hidden');
try{
faceDetection=new FaceDetection({locateFile:(file)=>{
return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
}});
faceDetection.setOptions({
model:'short',
minDetectionConfidence:0.5
});
await faceDetection.initialize();
loadingModel.classList.add('hidden');
console.log('MediaPipe chargé');
}catch(e){
console.error(e);
loadingModel.classList.add('hidden');
showError('Erreur de chargement de MediaPipe');
}
}

function showError(msg){
errorMsg.textContent=msg;
error.classList.remove('hidden');
setTimeout(()=>error.classList.add('hidden'),5000);
}

uploadBtn.onclick=()=>upload.click();

upload.onchange=e=>{
const file=e.target.files[0];
if(!file||!file.type.startsWith('video/'))return showError('Fichier vidéo invalide');
if(videoURL)URL.revokeObjectURL(videoURL);
videoURL=URL.createObjectURL(file);
video.src=videoURL;
document.querySelector('.app-container').classList.add('dark-mode');
mainSection.classList.remove('hidden');
$('upload-section').classList.add('hidden');
analysisSection.classList.add('hidden');
facesSection.classList.add('hidden');
processingSection.classList.add('hidden');
resultSection.classList.add('hidden');
detectedFaces=[];
selectedFaceIds.clear();
video.onloadedmetadata=()=>{
const mins=Math.floor(video.duration/60);
const secs=Math.floor(video.duration%60);
videoDuration.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;
videoResolution.textContent=`${video.videoWidth}x${video.videoHeight}`;
};
};

blurIntensity.oninput=()=>blurVal.textContent=blurIntensity.value;

function calculateIoU(box1,box2){
const x1=Math.max(box1.x,box2.x);
const y1=Math.max(box1.y,box2.y);
const x2=Math.min(box1.x+box1.width,box2.x+box2.width);
const y2=Math.min(box1.y+box1.height,box2.y+box2.height);
const intersect=Math.max(0,x2-x1)*Math.max(0,y2-y1);
const area1=box1.width*box1.height;
const area2=box2.width*box2.height;
const union=area1+area2-intersect;
return union>0?intersect/union:0;
}

analyzeBtn.onclick=async()=>{
if(!faceDetection)return showError('MediaPipe non chargé');
analyzeBtn.disabled=true;
analysisSection.classList.remove('hidden');
detectedFaces=[];

try{
tempCanvas.width=video.videoWidth;
tempCanvas.height=video.videoHeight;
const duration=video.duration;
const interval=0.3;
const totalSamples=Math.ceil(duration/interval);
let processed=0;

for(let time=0;time<duration;time+=interval){
video.currentTime=time;
await new Promise(r=>video.onseeked=r);
tempCtx.drawImage(video,0,0);

const results=await faceDetection.send({image:tempCanvas});

if(results.detections){
results.detections.forEach(det=>{
const bbox=det.boundingBox;
const w=bbox.width*tempCanvas.width;
const h=bbox.height*tempCanvas.height;
const x=bbox.xCenter*tempCanvas.width-w/2;
const y=bbox.yCenter*tempCanvas.height-h/2;
const pad=0.3;

const face={
x:Math.max(0,x-w*pad/2),
y:Math.max(0,y-h*pad/2),
width:w*(1+pad),
height:h*(1+pad),
time:time,
score:det.score[0]
};

let matched=false;
for(let p of detectedFaces){
const iou=calculateIoU(face,p.faces[0]);
if(iou>0.4){
p.faces.push(face);
matched=true;
break;
}
}

if(!matched){
detectedFaces.push({
id:detectedFaces.length,
faces:[face],
thumbnail:null,
isManual:false
});
}
});
}

processed++;
const pct=(processed/totalSamples)*100;
analysisBar.style.width=pct+'%';
analysisPercent.textContent=Math.round(pct)+'%';
analysisStatus.textContent=`${processed}/${totalSamples} - ${results.detections?results.detections.length:0} visage(s)`;
}

if(detectedFaces.length===0){
showError('Aucun visage détecté');
analysisSection.classList.add('hidden');
analyzeBtn.disabled=false;
return;
}

// Miniatures
for(let p of detectedFaces){
video.currentTime=p.faces[0].time;
await new Promise(r=>video.onseeked=r);
tempCtx.drawImage(video,0,0);
const tc=document.createElement('canvas');
tc.width=100;tc.height=100;
const tctx=tc.getContext('2d');
const f=p.faces[0];
tctx.drawImage(tempCanvas,f.x,f.y,f.width,f.height,0,0,100,100);
p.thumbnail=tc.toDataURL();
}

analysisSection.classList.add('hidden');
displayFaces();
detectedFaces.forEach(p=>selectedFaceIds.add(p.id));
facesSection.classList.remove('hidden');
processBtn.disabled=false;
analyzeBtn.disabled=false;

}catch(e){
console.error(e);
showError('Erreur d\'analyse');
analysisSection.classList.add('hidden');
analyzeBtn.disabled=false;
}
};

function displayFaces(){
facesGrid.innerHTML='';
facesCount.textContent=detectedFaces.length;
detectedFaces.forEach(p=>{
const card=document.createElement('div');
card.className='face-card p-2 rounded-lg cursor-pointer'+(selectedFaceIds.has(p.id)?' selected':'');
card.onclick=()=>{
if(selectedFaceIds.has(p.id)){
selectedFaceIds.delete(p.id);
card.classList.remove('selected');
card.querySelector('input').checked=false;
}else{
selectedFaceIds.add(p.id);
card.classList.add('selected');
card.querySelector('input').checked=true;
}
processBtn.disabled=selectedFaceIds.size===0;
};

const img=document.createElement('img');
img.src=p.thumbnail;
img.className='face-thumb mx-auto mb-2';

const chk=document.createElement('input');
chk.type='checkbox';
chk.checked=selectedFaceIds.has(p.id);
chk.className='mr-1';
const lbl=document.createElement('label');
lbl.className='text-white text-xs flex items-center justify-center';
lbl.appendChild(chk);
lbl.appendChild(document.createTextNode(p.isManual?`Visage ${p.id+1} (M)`:`Visage ${p.id+1}`));

card.appendChild(img);
card.appendChild(lbl);
facesGrid.appendChild(card);
});
processBtn.disabled=selectedFaceIds.size===0;
}

selectAll.onclick=()=>{
detectedFaces.forEach(p=>selectedFaceIds.add(p.id));
displayFaces();
};

selectNone.onclick=()=>{
selectedFaceIds.clear();
displayFaces();
};

// Traitement avec MediaPipe
processBtn.onclick=async()=>{
if(selectedFaceIds.size===0)return showError('Sélectionnez au moins un visage');

processBtn.disabled=true;
mainSection.classList.add('hidden');
processingSection.classList.remove('hidden');

const trackers=new Map();
selectedFaceIds.forEach(id=>{
trackers.set(id,{
active:false,
lastBox:null,
history:[],
lostFrames:0
});
});

try{
processCanvas.width=video.videoWidth;
processCanvas.height=video.videoHeight;
const stream=processCanvas.captureStream(30);
const rec=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9',videoBitsPerSecond:4e6});
const chunks=[];
rec.ondataavailable=e=>chunks.push(e.data);
rec.onstop=()=>{
const blob=new Blob(chunks,{type:'video/webm'});
resultVideo.src=URL.createObjectURL(blob);
processingSection.classList.add('hidden');
resultSection.classList.remove('hidden');
processBtn.disabled=false;
};

rec.start();
video.currentTime=0;
await new Promise(r=>video.onseeked=r);
video.play();

const blur=parseInt(blurIntensity.value);
const startTime=Date.now();
let frameNum=0;

async function processFrame(){
if(video.paused||video.ended){
rec.stop();
return;
}

frameNum++;
processCtx.filter='none';
processCtx.drawImage(video,0,0);
tempCtx.drawImage(video,0,0);

const results=await faceDetection.send({image:tempCanvas});
const currentBoxes=[];

if(results.detections){
results.detections.forEach(det=>{
const bbox=det.boundingBox;
const w=bbox.width*tempCanvas.width;
const h=bbox.height*tempCanvas.height;
const x=bbox.xCenter*tempCanvas.width-w/2;
const y=bbox.yCenter*tempCanvas.height-h/2;
const pad=0.3;
currentBoxes.push({
x:Math.max(0,x-w*pad/2),
y:Math.max(0,y-h*pad/2),
width:w*(1+pad),
height:h*(1+pad),
score:det.score[0]
});
});
}

for(let[personId,tracker]of trackers){
const person=detectedFaces.find(p=>p.id===personId);
if(!person)continue;

let matchedBox=null;
let bestScore=0;

if(!tracker.active){
for(let box of currentBoxes){
const score=Math.max(...person.faces.map(ref=>calculateIoU(box,ref)));
if(score>0.5&&score>bestScore){
bestScore=score;
matchedBox=box;
}
}
if(matchedBox){
tracker.active=true;
tracker.lastBox=matchedBox;
tracker.history=[matchedBox];
tracker.lostFrames=0;
}
}else{
for(let box of currentBoxes){
const score=calculateIoU(box,tracker.lastBox);
if(score>0.4&&score>bestScore){
bestScore=score;
matchedBox=box;
}
}

if(matchedBox){
const smoothed={
x:0.75*matchedBox.x+0.25*tracker.lastBox.x,
y:0.75*matchedBox.y+0.25*tracker.lastBox.y,
width:0.75*matchedBox.width+0.25*tracker.lastBox.width,
height:0.75*matchedBox.height+0.25*tracker.lastBox.height
};
tracker.lastBox=smoothed;
tracker.history.push(smoothed);
if(tracker.history.length>5)tracker.history.shift();
tracker.lostFrames=0;
}else{
tracker.lostFrames++;
if(tracker.lostFrames<20&&tracker.history.length>=2){
const prev=tracker.history[tracker.history.length-2];
const last=tracker.history[tracker.history.length-1];
const vx=last.x-prev.x;
const vy=last.y-prev.y;
tracker.lastBox={
x:last.x+vx*tracker.lostFrames*0.8,
y:last.y+vy*tracker.lostFrames*0.8,
width:last.width,
height:last.height
};
}else if(tracker.lostFrames>=20){
tracker.active=false;
}
}
}

if(tracker.active&&tracker.lastBox){
const box=tracker.lastBox;
processCtx.save();
processCtx.beginPath();
processCtx.ellipse(box.x+box.width/2,box.y+box.height/2,box.width/2,box.height/2,0,0,2*Math.PI);
processCtx.clip();
processCtx.filter=`blur(${blur}px)`;
processCtx.drawImage(video,0,0);
processCtx.restore();
}
}

const pct=(video.currentTime/video.duration)*100;
processingBar.style.width=pct+'%';
processingPercent.textContent=Math.round(pct)+'%';
const elapsed=(Date.now()-startTime)/1000;
const remaining=Math.max(0,(elapsed/(pct/100))-elapsed);
const m=Math.floor(remaining/60),s=Math.floor(remaining%60);
timeRemaining.textContent=`${m}:${s.toString().padStart(2,'0')}`;
const activeCount=Array.from(trackers.values()).filter(t=>t.active).length;
processingStatus.textContent=`Frame ${frameNum} - ${activeCount}/${selectedFaceIds.size} actifs`;

requestAnimationFrame(processFrame);
}

processFrame();

}catch(e){
console.error(e);
showError('Erreur de traitement');
processingSection.classList.add('hidden');
mainSection.classList.remove('hidden');
processBtn.disabled=false;
}
};

downloadBtn.onclick=()=>{
const a=document.createElement('a');
a.href=resultVideo.src;
a.download='video-floutee.webm';
a.click();
};

restartBtn.onclick=()=>{
resultSection.classList.add('hidden');
mainSection.

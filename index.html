<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Floutage MediaPipe</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
<link rel="stylesheet" href="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.css">
<script src="https://alixb-accessible.github.io/faites-mieux-toolbar/faites-mieux.js" defer></script>
<style>
body{background:linear-gradient(135deg,#4a4a4a 0%,#4a4a4a 14.28%,#22c55e 14.28%,#22c55e 28.56%,#3b82f6 28.56%,#3b82f6 42.84%,#fff 42.84%,#fff 57.12%,#fbbf24 57.12%,#fbbf24 71.4%,#dc2626 71.4%,#dc2626 85.68%,#4a4a4a 85.68%,#4a4a4a 100%);min-height:100vh}
.app{min-height:100vh}.app.dark{background:#1a1a1a}
.fc{border:2px solid #333;background:#2a2a2a;transition:all .3s;cursor:pointer;padding:0.5rem;border-radius:0.5rem}
.fc:hover{border-color:#3b82f6}.fc.sel{border-color:#22c55e;background:#1e3a1e}
.ft{width:100px;height:100px;object-fit:cover;border-radius:8px}
.btn{transition:all .3s;font-weight:600}.btn:disabled{opacity:.4;cursor:not-allowed}
@keyframes spin{to{transform:rotate(360deg)}}.spin{animation:spin 1s linear infinite}
.vc{background:#000;border-radius:12px;max-height:70vh;display:flex;align-items:center;justify-content:center}
.vc video{max-width:100%;max-height:70vh;width:auto;height:auto}
</style>
</head>
<body>
<div class="app min-h-screen p-6">
<div class="max-w-7xl mx-auto">

<div class="text-center mb-8">
<h1 class="text-4xl font-bold text-white mb-2">Floutage avec MediaPipe</h1>
<p class="text-gray-400">Détection plus précise et meilleur tracking</p>
</div>

<div id="load" class="hidden bg-blue-900/50 border border-blue-500/50 rounded-lg p-4 mb-6 flex items-center gap-3">
<svg class="spin h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
<p class="text-blue-200">Chargement de MediaPipe...</p>
</div>

<div id="err" class="hidden bg-red-900/50 border border-red-500/50 rounded-lg p-4 mb-6"><p id="errMsg" class="text-red-200"></p></div>

<div id="upSec" class="bg-gray-800 rounded-lg p-8 text-center mb-6">
<input type="file" id="up" accept="video/*" class="hidden">
<button id="upBtn" class="btn bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-500 text-lg">Importer vidéo</button>
<p class="text-gray-400 mt-4 text-sm">MP4, WebM, MOV</p>
</div>

<div id="mainSec" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
<div class="lg:col-span-2">
<div class="vc"><video id="vid" controls class="w-full"></video></div>
<div class="mt-4 flex gap-3">
<button id="anaBtn" class="btn flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500">Analyser</button>
<button id="procBtn" disabled class="btn flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-500">Traiter</button>
</div>
</div>

<div class="bg-gray-800 rounded-lg p-6">
<div class="mb-4">
<p class="text-gray-400 text-xs">Durée: <span id="dur" class="text-white font-mono">--:--</span></p>
<p class="text-gray-400 text-xs">Résolution: <span id="res" class="text-white font-mono">----</span></p>
</div>

<div class="mb-4">
<label class="block text-white font-semibold mb-2 text-sm">Intensité flou</label>
<input type="range" id="blur" min="10" max="50" value="25" class="w-full">
<p class="text-gray-400 text-xs mt-1 text-center"><span id="blurVal" class="text-white">25</span>px</p>
</div>

<div id="fSec" class="hidden">
<div class="flex justify-between mb-3">
<h3 class="text-white font-semibold text-sm">Visages (<span id="fCnt">0</span>)</h3>
</div>
<div class="flex gap-2 mb-3">
<button id="selAll" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 flex-1">Tout</button>
<button id="selNone" class="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-500 flex-1">Aucun</button>
</div>
<div id="fGrid" class="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto"></div>
</div>
</div>
</div>

<div id="anaSec" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
<div class="flex items-center gap-4 mb-4">
<svg class="spin h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
<div><p class="text-white font-semibold">Analyse MediaPipe...</p><p class="text-gray-400 text-sm" id="anaSt">Init...</p></div>
</div>
<div class="w-full bg-gray-700 rounded-full h-2"><div id="anaBar" class="bg-purple-500 h-full rounded-full" style="width:0%"></div></div>
<p class="text-gray-400 text-xs mt-2" id="anaPct">0%</p>
</div>

<div id="procSec" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
<div class="flex items-center gap-4 mb-4">
<svg class="spin h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>
<div><p class="text-white font-semibold">Traitement...</p><p class="text-gray-400 text-sm" id="procSt">Frame 0</p></div>
</div>
<div class="w-full bg-gray-700 rounded-full h-2"><div id="procBar" class="bg-green-500 h-full rounded-full" style="width:0%"></div></div>
<p class="text-gray-400 text-xs mt-2"><span id="procPct">0%</span> - <span id="remain">--:--</span></p>
</div>

<div id="resSec" class="hidden bg-gray-800 rounded-lg p-6">
<h2 class="text-white font-semibold mb-4 text-lg">Vidéo traitée</h2>
<video id="resVid" controls class="w-full rounded-lg bg-black mb-4"></video>
<div class="flex gap-3">
<button id="dlBtn" class="btn flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-500">Télécharger</button>
<button id="rstBtn" class="btn flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-500">Nouvelle</button>
</div>
</div>

<canvas id="tc" style="display:none"></canvas>
<canvas id="pc" style="display:none"></canvas>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let fd=null,vu=null,faces=[],selIds=new Set();

const load=$('load'),err=$('err'),errMsg=$('errMsg'),upBtn=$('upBtn'),up=$('up');
const mainSec=$('mainSec'),vid=$('vid'),dur=$('dur'),res=$('res');
const anaBtn=$('anaBtn'),procBtn=$('procBtn');
const anaSec=$('anaSec'),anaBar=$('anaBar'),anaPct=$('anaPct'),anaSt=$('anaSt');
const fSec=$('fSec'),fCnt=$('fCnt'),fGrid=$('fGrid'),selAll=$('selAll'),selNone=$('selNone');
const blur=$('blur'),blurVal=$('blurVal');
const procSec=$('procSec'),procBar=$('procBar'),procPct=$('procPct'),procSt=$('procSt'),remain=$('remain');
const resSec=$('resSec'),resVid=$('resVid'),dlBtn=$('dlBtn'),rstBtn=$('rstBtn');
const tc=$('tc'),pc=$('pc'),tctx=tc.getContext('2d'),pctx=pc.getContext('2d');

async function loadModel(){
load.classList.remove('hidden');
try{
fd=new FaceDetection({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${f}`});
fd.setOptions({model:'short',minDetectionConfidence:0.5});
await fd.initialize();
load.classList.add('hidden');
console.log('MP OK');
}catch(e){
console.error(e);
load.classList.add('hidden');
errMsg.textContent='Erreur MediaPipe';
err.classList.remove('hidden');
}
}

function showErr(m){
errMsg.textContent=m;
err.classList.remove('hidden');
setTimeout(()=>err.classList.add('hidden'),5000);
}

upBtn.onclick=()=>up.click();

up.onchange=e=>{
const f=e.target.files[0];
if(!f||!f.type.startsWith('video/'))return showErr('Fichier invalide');
if(vu)URL.revokeObjectURL(vu);
vu=URL.createObjectURL(f);
vid.src=vu;
document.querySelector('.app').classList.add('dark');
mainSec.classList.remove('hidden');
$('upSec').classList.add('hidden');
anaSec.classList.add('hidden');
fSec.classList.add('hidden');
procSec.classList.add('hidden');
resSec.classList.add('hidden');
faces=[];
selIds.clear();
vid.onloadedmetadata=()=>{
const m=Math.floor(vid.duration/60),s=Math.floor(vid.duration%60);
dur.textContent=`${m}:${s.toString().padStart(2,'0')}`;
res.textContent=`${vid.videoWidth}x${vid.videoHeight}`;
};
};

blur.oninput=()=>blurVal.textContent=blur.value;

function iou(b1,b2){
const x1=Math.max(b1.x,b2.x),y1=Math.max(b1.y,b2.y);
const x2=Math.min(b1.x+b1.width,b2.x+b2.width),y2=Math.min(b1.y+b1.height,b2.y+b2.height);
const i=Math.max(0,x2-x1)*Math.max(0,y2-y1);
const u=b1.width*b1.height+b2.width*b2.height-i;
return u>0?i/u:0;
}

anaBtn.onclick=async()=>{
if(!fd)return showErr('MP non chargé');
anaBtn.disabled=true;
anaSec.classList.remove('hidden');
faces=[];

try{
tc.width=vid.videoWidth;
tc.height=vid.videoHeight;
const d=vid.duration,iv=0.3,tot=Math.ceil(d/iv);
let proc=0;

for(let t=0;t<d;t+=iv){
vid.currentTime=t;
await new Promise(r=>vid.onseeked=r);
tctx.drawImage(vid,0,0);

const r=await fd.send({image:tc});

if(r.detections){
r.detections.forEach(det=>{
const bb=det.boundingBox;
const w=bb.width*tc.width,h=bb.height*tc.height;
const x=bb.xCenter*tc.width-w/2,y=bb.yCenter*tc.height-h/2;
const pad=0.3;
const face={
x:Math.max(0,x-w*pad/2),
y:Math.max(0,y-h*pad/2),
width:w*(1+pad),
height:h*(1+pad),
time:t
};

let match=false;
for(let p of faces){
if(iou(face,p.faces[0])>0.4){
p.faces.push(face);
match=true;
break;
}
}
if(!match)faces.push({id:faces.length,faces:[face],thumb:null});
});
}

proc++;
const pct=(proc/tot)*100;
anaBar.style.width=pct+'%';
anaPct.textContent=Math.round(pct)+'%';
anaSt.textContent=`${proc}/${tot} - ${r.detections?r.detections.length:0} visage(s)`;
}

if(!faces.length){
showErr('Aucun visage');
anaSec.classList.add('hidden');
anaBtn.disabled=false;
return;
}

for(let p of faces){
vid.currentTime=p.faces[0].time;
await new Promise(r=>vid.onseeked=r);
tctx.drawImage(vid,0,0);
const c=document.createElement('canvas');
c.width=100;c.height=100;
const ctx=c.getContext('2d');
const f=p.faces[0];
ctx.drawImage(tc,f.x,f.y,f.width,f.height,0,0,100,100);
p.thumb=c.toDataURL();
}

anaSec.classList.add('hidden');
showFaces();
faces.forEach(p=>selIds.add(p.id));
fSec.classList.remove('hidden');
procBtn.disabled=false;
anaBtn.disabled=false;

}catch(e){
console.error(e);
showErr('Erreur analyse');
anaSec.classList.add('hidden');
anaBtn.disabled=false;
}
};

function showFaces(){
fGrid.innerHTML='';
fCnt.textContent=faces.length;
faces.forEach(p=>{
const d=document.createElement('div');
d.className='fc'+(selIds.has(p.id)?' sel':'');
d.onclick=()=>{
if(selIds.has(p.id)){
selIds.delete(p.id);
d.classList.remove('sel');
d.querySelector('input').checked=false;
}else{
selIds.add(p.id);
d.classList.add('sel');
d.querySelector('input').checked=true;
}
procBtn.disabled=!selIds.size;
};

const img=document.createElement('img');
img.src=p.thumb;
img.className='ft mx-auto mb-2';

const ch=document.createElement('input');
ch.type='checkbox';
ch.checked=selIds.has(p.id);
ch.className='mr-1';
const lb=document.createElement('label');
lb.className='text-white text-xs flex items-center justify-center';
lb.appendChild(ch);
lb.appendChild(document.createTextNode(`Visage ${p.id+1}`));

d.appendChild(img);
d.appendChild(lb);
fGrid.appendChild(d);
});
procBtn.disabled=!selIds.size;
}

selAll.onclick=()=>{faces.forEach(p=>selIds.add(p.id));showFaces();};
selNone.onclick=()=>{selIds.clear();showFaces();};

procBtn.onclick=async()=>{
if(!selIds.size)return showErr('Sélectionnez visages');

procBtn.disabled=true;
mainSec.classList.add('hidden');
procSec.classList.remove('hidden');

const trk=new Map();
selIds.forEach(id=>trk.set(id,{on:false,box:null,hist:[],lost:0}));

try{
pc.width=vid.videoWidth;
pc.height=vid.videoHeight;
const st=pc.captureStream(30);
const rec=new MediaRecorder(st,{mimeType:'video/webm;codecs=vp9',videoBitsPerSecond:4e6});
const ch=[];
rec.ondataavailable=e=>ch.push(e.data);
rec.onstop=()=>{
resVid.src=URL.createObjectURL(new Blob(ch,{type:'video/webm'}));
procSec.classList.add('hidden');
resSec.classList.remove('hidden');
procBtn.disabled=false;
};

rec.start();
vid.currentTime=0;
await new Promise(r=>vid.onseeked=r);
vid.play();

const bl=parseInt(blur.value);
const t0=Date.now();
let fn=0;

async function pf(){
if(vid.paused||vid.ended){rec.stop();return;}

fn++;
pctx.filter='none';
pctx.drawImage(vid,0,0);
tctx.drawImage(vid,0,0);

const r=await fd.send({image:tc});
const cb=[];

if(r.detections){
r.detections.forEach(det=>{
const bb=det.boundingBox;
const w=bb.width*tc.width,h=bb.height*tc.height;
const x=bb.xCenter*tc.width-w/2,y=bb.yCenter*tc.height-h/2;
const pad=0.3;
cb.push({x:Math.max(0,x-w*pad/2),y:Math.max(0,y-h*pad/2),width:w*(1+pad),height:h*(1+pad)});
});
}

for(let[pid,tr]of trk){
const p=faces.find(f=>f.id===pid);
if(!p)continue;

let mb=null,bs=0;

if(!tr.on){
for(let b of cb){
const s=Math.max(...p.faces.map(rf=>iou(b,rf)));
if(s>0.5&&s>bs){bs=s;mb=b;}
}
if(mb){
tr.on=true;
tr.box=mb;
tr.hist=[mb];
tr.lost=0;
}
}else{
for(let b of cb){
const s=iou(b,tr.box);
if(s>0.4&&s>bs){bs=s;mb=b;}
}

if(mb){
const sm={
x:0.75*mb.x+0.25*tr.box.x,
y:0.75*mb.y+0.25*tr.box.y,
width:0.75*mb.width+0.25*tr.box.width,
height:0.75*mb.height+0.25*tr.box.height
};
tr.box=sm;
tr.hist.push(sm);
if(tr.hist.length>5)tr.hist.shift();
tr.lost=0;
}else{
tr.lost++;
if(tr.lost<20&&tr.hist.length>=2){
const pv=tr.hist[tr.hist.length-2],ls=tr.hist[tr.hist.length-1];
const vx=ls.x-pv.x,vy=ls.y-pv.y;
tr.box={x:ls.x+vx*tr.lost*0.8,y:ls.y+vy*tr.lost*0.8,width:ls.width,height:ls.height};
}else if(tr.lost>=20){
tr.on=false;
}
}
}

if(tr.on&&tr.box){
const b=tr.box;
pctx.save();
pctx.beginPath();
pctx.ellipse(b.x+b.width/2,b.y+b.height/2,b.width/2,b.height/2,0,0,2*Math.PI);
pctx.clip();
pctx.filter=`blur(${bl}px)`;
pctx.drawImage(vid,0,0);
pctx.restore();
}
}

const pct=(vid.currentTime/vid.duration)*100;
procBar.style.width=pct+'%';
procPct.textContent=Math.round(pct)+'%';
const el=(Date.now()-t0)/1000;
const rm=Math.max(0,(el/(pct/100))-el);
const m=Math.floor(rm/60),s=Math.floor(rm%60);
remain.textContent=`${m}:${s.toString().padStart(2,'0')}`;
const ac=Array.from(trk.values()).filter(t=>t.on).length;
procSt.textContent=`Frame ${fn} - ${ac}/${selIds.size} actifs`;

requestAnimationFrame(pf);
}

pf();

}catch(e){
console.error(e);
showErr('Erreur traitement');
procSec.classList.add('hidden');
mainSec.classList.remove('hidden');
procBtn.disabled=false;
}
};

dlBtn.onclick=()=>{
const a=document.createElement('a');
a.href=resVid.src;
a.download='video-floutee.webm';
a.click();
};

rstBtn.onclick=()=>{
resSec.classList.add('hidden');
mainSec.classList.add('hidden');
document.querySelector('.app').classList.remove('dark');
$('upSec').classList.remove('hidden');
if(vu)URL.revokeObjectURL(vu);
vu=null;
faces=[];
selIds.clear();
vid.src='';
up.value='';
};

loadModel();
</script>
</body>
</html>
